╔══════════════════════════════════════════════════════════════════════════════╗
║                    RAG PIPELINE - LEGAL CHATBOT                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. USER INPUT                                                                │
│    "xe máy vượt đèn đỏ bị phạt bao nhiêu?"                                  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. BACKEND API (FastAPI /chat)                                              │
│    - Nhận POST request                                                      │
│    - Normalize input (trim, lowercase)                                      │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. GUARDRAIL CLASSIFICATION                                                 │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ Check: Small talk? Out of scope?                                   │  │
│    │                                                                     │  │
│    │ IF small_talk → Return "Mình là trợ lý..."                        │  │
│    │ IF out_of_scope → Return "Chỉ hỗ trợ luật giao thông..."          │  │
│    │ IF legal question → Continue                                       │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. QUESTION REWRITE (Optional)                                             │
│    - Thêm "bị phạt bao nhiêu" nếu thiếu                                    │
│    - Chuẩn hóa thứ tự từ                                                   │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. RAG RETRIEVAL                                                            │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 5.1. QUERY ANALYSIS                                                 │  │
│    │    ├─ Extract tags: {"den_tin_hieu"}                               │  │
│    │    ├─ Detect vehicle: 7 (xe máy)                                    │  │
│    │    ├─ Extract speed: None                                           │  │
│    │    └─ Detect subject: Cá nhân (Điều 6-21)                           │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                │                                             │
│                                ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 5.2. TAG-BASED RETRIEVAL                                            │  │
│    │    behavior_index["den_tin_hieu"] → [0, 5, 12, 67, ...]            │  │
│    │    behavior_chunk_indices = {0, 5, 12, 67, ...}                    │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                │                                             │
│                                ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 5.3. SEMANTIC SEARCH (if enabled)                                   │  │
│    │    ├─ Encode query → embedding (384D)                               │  │
│    │    ├─ Cosine similarity: scores = embeddings @ query_emb            │  │
│    │    ├─ Top-K: [(9, 0.84), (67, 0.58), (6, 0.56), ...]               │  │
│    │    └─ Merge: behavior_chunk_indices.update([9, 67, 6, ...])        │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                │                                             │
│                                ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 5.4. MULTI-STAGE FILTERING                                          │  │
│    │    ├─ Filter by subject: Cá nhân → Điều 6-21                       │  │
│    │    ├─ Filter by vehicle: Xe máy → article == 7                     │  │
│    │    ├─ Filter by content: "xe máy" in content                       │  │
│    │    └─ Result: 7 chunks                                              │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                │                                             │
│                                ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 5.5. PRIMARY CHUNK SELECTION                                       │  │
│    │    Priority: Highest penalty → Điều 7 khoản 7 điểm c               │  │
│    │    Result:                                                          │  │
│    │      - primary_chunk: Điều 7 khoản 7 điểm c                         │  │
│    │      - escalation_chunks: []                                        │  │
│    │      - status: "success"                                            │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 6. CONTEXT FORMATTING                                                        │
│    Format: "Theo Điều 7 khoản 7 điểm c, 7. Phạt tiền từ 4.000.000 đồng..." │
│    Include: Mức phạt, trừ điểm, tước GPLX                                  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 7. MODEL GENERATION (if enabled)                                            │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 7.1. Build Prompt                                                    │  │
│    │    System: "Bạn là trợ lý pháp luật giao thông..."                  │  │
│    │    Context: Formatted legal info from RAG                            │  │
│    │    User: "xe máy vượt đèn đỏ bị phạt bao nhiêu?"                    │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                │                                             │
│                                ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 7.2. Generate Answer                                                │  │
│    │    Model: Qwen3-0.6B-Instruct                                        │  │
│    │    Output: "Theo quy định, xe máy vượt đèn đỏ sẽ bị phạt..."        │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                │                                             │
│                                ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ 7.3. Small Talk Filter                                              │  │
│    │    Check: Contains "Mình là trợ lý..."?                              │  │
│    │    IF yes → Clear answer, use fallback                              │  │
│    │    IF no → Keep answer                                              │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 8. ANSWER SELECTION                                                         │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ IF model answer exists AND not small talk:                          │  │
│    │   → Append RAG citation to model answer                             │  │
│    │   → Source: model_with_rag_citation                                  │  │
│    │                                                                      │  │
│    │ IF model answer is small talk OR no model answer:                   │  │
│    │   → Use fallback answer from RAG                                    │  │
│    │   → Source: fallback                                                │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 9. STREAMING RESPONSE                                                       │
│    For each word in final_answer:                                           │
│      yield word + " "                                                       │
│    Frontend displays text as it streams                                     │
└─────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                          KEY COMPONENTS                                      ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ DATA SOURCES                                                                 │
│  • nd168_metadata_clean.json (1459 legal chunks)                           │
│  • backend/semantic_index/embeddings.npy (pre-computed vectors)            │
│  • backend/semantic_index/metadata.json (doc_id mapping)                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ INDEXES                                                                      │
│  • behavior_index: {tag → [chunk_idx1, chunk_idx2, ...]}                   │
│  • escalation_chunks: [chunk_idx1, chunk_idx2, ...]                         │
│  • doc_id_to_chunk_idx: {doc_id → chunk_idx}                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MODELS                                                                       │
│  • Semantic: paraphrase-multilingual-MiniLM-L12-v2 (384D embeddings)         │
│  • Generation: Qwen3-0.6B-Instruct (fine-tuned for traffic law)            │
└─────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                          DECISION POINTS                                    ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ GUARDRAIL → RAG?                                                             │
│  • Small talk? → Return immediately                                          │
│  • Out of scope? → Return immediately                                        │
│  • Legal question? → Continue to RAG                                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ TAG-BASED vs SEMANTIC?                                                       │
│  • Has tags? → Use both tag-based + semantic                                │
│  • No tags? → Rely on semantic only (if enabled)                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ MODEL vs FALLBACK?                                                           │
│  • Model answer valid? → Use model + RAG citation                            │
│  • Model answer small talk? → Use fallback from RAG                         │
│  • No model answer? → Use fallback from RAG                                  │
└─────────────────────────────────────────────────────────────────────────────┘

