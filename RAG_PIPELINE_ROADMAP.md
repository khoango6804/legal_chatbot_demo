# ğŸ—ºï¸ RAG Pipeline Roadmap - Legal Chatbot

## ğŸ“‹ Tá»•ng quan Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER INPUT: CÃ¢u há»i tá»« Frontend                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: BACKEND API (FastAPI) - /chat endpoint                        â”‚
â”‚  - Nháº­n POST request vá»›i {"question": "..."}                              â”‚
â”‚  - Chuáº©n hÃ³a input (trim, normalize)                                     â”‚
â”‚  - Táº¡o StreamingResponse generator                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: HYBRID ASSISTANT - answer(question)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2.1. Normalize Input                                              â”‚  â”‚
â”‚  â”‚      - normalize_input_text()                                      â”‚  â”‚
â”‚  â”‚      - Lowercase, trim whitespace                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2.2. Guardrail Classification                                     â”‚  â”‚
â”‚  â”‚      - _guardrail_classify()                                      â”‚  â”‚
â”‚  â”‚      - Check SMALL_TALK_PATTERNS (hi, xin chÃ o, báº¡n lÃ  ai...)     â”‚  â”‚
â”‚  â”‚      - Check OUT_OF_SCOPE_PATTERNS                                â”‚  â”‚
â”‚  â”‚      - Heuristic: short question without legal keywords           â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ IF small_talk â†’ return DEFAULT_SMALL_TALK_REPLY          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚ IF out_of_scope â†’ return DEFAULT_OUT_OF_SCOPE_REPLY     â”‚  â”‚  â”‚
â”‚  â”‚      â”‚ IF None â†’ Continue to RAG                                â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2.3. Question Rewrite (Optional)                                  â”‚  â”‚
â”‚  â”‚      - _rewrite_question()                                        â”‚  â”‚
â”‚  â”‚      - Rule-based: thÃªm "bá»‹ pháº¡t bao nhiÃªu" náº¿u thiáº¿u           â”‚  â”‚
â”‚  â”‚      - Chuáº©n hÃ³a thá»© tá»± tá»« (xe mÃ¡y/Ã´ tÃ´ lÃªn trÆ°á»›c)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2.4. RAG Retrieval                                                â”‚  â”‚
â”‚  â”‚      - _retrieve_with_variations()                                â”‚  â”‚
â”‚  â”‚      - Gá»i rag.retrieve(question)                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: RAG PIPELINE - retrieve(query)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3.1. Query Analysis                                               â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.1.1. Extract Behavior Tags                           â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - _extract_tags()                                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Match vá»›i BEHAVIOR_KEYWORDS:                   â”‚  â”‚  â”‚
â”‚  â”‚      â”‚          * den_tin_hieu: ["vÆ°á»£t Ä‘Ã¨n Ä‘á»", ...]          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚          * dua_xe: ["Ä‘ua xe", "bá»‘c Ä‘áº§u", ...]          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚          * dien_thoai: ["Ä‘iá»‡n thoáº¡i", ...]              â”‚  â”‚  â”‚
â”‚  â”‚      â”‚          * qua_toc_do: ["quÃ¡ tá»‘c Ä‘á»™", ...]              â”‚  â”‚  â”‚
â”‚  â”‚      â”‚          * khong_doi_mu: ["khÃ´ng Ä‘á»™i mÅ©", ...]           â”‚  â”‚  â”‚
â”‚  â”‚      â”‚          * ... (60+ tags)                               â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.1.2. Detect Vehicle Type                              â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - _detect_vehicle_type()                          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Xe mÃ¡y: ["xe mÃ¡y", "mÃ´ tÃ´", "xe 2 bÃ¡nh"]       â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Ã” tÃ´: ["Ã´ tÃ´", "oto", "xe 4 bÃ¡nh"]             â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Return: 6 (Ã´ tÃ´) hoáº·c 7 (xe mÃ¡y)               â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.1.3. Extract Speed Range                              â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - _extract_speed_range()                         â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Regex: (\d+)\s*km/h                            â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Map speed â†’ khoáº£n (VD: 10-20km/h â†’ khoáº£n 4)    â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.1.4. Detect Subject Type                               â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - CÃ¡ nhÃ¢n (default): Äiá»u 6-21                   â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Tá»• chá»©c: ["tá»• chá»©c", "doanh nghiá»‡p"] â†’ Äiá»u 30+â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.1.5. Detect Special Cases                              â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - has_tai_nan: ["gÃ¢y tai náº¡n", "bá» cháº¡y"]        â”‚  â”‚  â”‚
â”‚  â”‚        - is_load_query: ["táº£i trá»ng", "quÃ¡ táº£i"]               â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3.2. Tag-Based Retrieval                                         â”‚  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ FOR each tag in query_tags:                             â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   IF tag in behavior_index:                              â”‚  â”‚  â”‚
â”‚  â”‚      â”‚     behavior_chunk_indices.update(behavior_index[tag])  â”‚  â”‚  â”‚
â”‚  â”‚      â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚ behavior_index = {                                      â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   "den_tin_hieu": [0, 5, 12, ...],                     â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   "dua_xe": [35, 67, ...],                             â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   ...                                                   â”‚  â”‚  â”‚
â”‚  â”‚      â”‚ }                                                       â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3.3. Semantic Search (if enabled)                                â”‚  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.3.1. Encode Query                                      â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Model: paraphrase-multilingual-MiniLM-L12-v2   â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - encoder.encode(query) â†’ query_embedding (384D)  â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.3.2. Cosine Similarity Search                         â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - scores = embeddings @ query_embedding           â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Top-K chunks (default: 15)                     â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Min score threshold: 0.35                      â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Return: [(chunk_idx, score), ...]             â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.3.3. Merge with Tag-Based Results                     â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - behavior_chunk_indices.update(semantic_indices) â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3.4. Multi-Stage Filtering                                        â”‚  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.4.1. Filter by Subject Type                           â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - CÃ¡ nhÃ¢n: article 6-21                          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Tá»• chá»©c: article 30+                           â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.4.2. Filter by Vehicle Type                            â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Xe mÃ¡y: article == 7                           â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Ã” tÃ´: article == 6                             â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Exception: Ä‘ua_xe â†’ Äiá»u 35 (cross-vehicle)    â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.4.3. Content-Based Filtering                          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - Match vehicle terms in chunk content            â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - VD: "xe mÃ¡y" in content â†’ prioritize          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - TAG_CONTENT_RULES: positive/negative keywords  â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ 3.4.4. Speed-Specific Filtering                         â”‚  â”‚  â”‚
â”‚  â”‚      â”‚        - IF speed_kmh detected:                         â”‚  â”‚  â”‚
â”‚  â”‚      â”‚          target_khoan = _get_speed_violation_khoan()   â”‚  â”‚  â”‚
â”‚  â”‚      â”‚          Filter chunks to match target_khoan            â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3.5. Primary Chunk Selection                                     â”‚  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ Priority Logic:                                          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚  1. IF has_tai_nan AND escalation chunk:                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ Select escalation chunk (priority 100)          â”‚  â”‚  â”‚
â”‚  â”‚      â”‚  2. IF speed violation:                                 â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ Select chunk matching target_khoan              â”‚  â”‚  â”‚
â”‚  â”‚      â”‚  3. IF multiple chunks:                                 â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ Select chunk with highest penalty                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚  4. ELSE:                                                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ Select by priority score                        â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ Build Result:                                            â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   - primary_chunk: ChunkMetadata                         â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   - escalation_chunks: List[ChunkMetadata]               â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   - status: "success"                                    â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: CONTEXT FORMATTING                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 4.1. Format Context for Model                                    â”‚  â”‚  â”‚
â”‚  â”‚      - _format_context(retrieval_result)                         â”‚  â”‚  â”‚
â”‚  â”‚      - Extract: Äiá»u, khoáº£n, Ä‘iá»ƒm                               â”‚  â”‚  â”‚
â”‚  â”‚      - Format: Má»©c pháº¡t, trá»« Ä‘iá»ƒm, tÆ°á»›c GPLX                    â”‚  â”‚  â”‚
â”‚  â”‚      - Include escalation chunks if available                    â”‚  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: MODEL GENERATION (if use_generation=True)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 5.1. Build Prompt                                                 â”‚  â”‚  â”‚
â”‚  â”‚      - System prompt: "Báº¡n lÃ  trá»£ lÃ½ phÃ¡p luáº­t giao thÃ´ng..."    â”‚  â”‚  â”‚
â”‚  â”‚      - Context: Formatted legal information from RAG             â”‚  â”‚  â”‚
â”‚  â”‚      - User question: Normalized/rewritten question               â”‚  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 5.2. Generate Answer                                              â”‚  â”‚  â”‚
â”‚  â”‚      - Model: Qwen3-0.6B-Instruct (fine-tuned)                   â”‚  â”‚  â”‚
â”‚  â”‚      - Framework: Unsloth (optimized inference)                   â”‚  â”‚  â”‚
â”‚  â”‚      - Max tokens: 120 (default)                                  â”‚  â”‚  â”‚
â”‚  â”‚      - Return: (cleaned_answer, raw_answer)                      â”‚  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 5.3. Small Talk Filtering                                         â”‚  â”‚  â”‚
â”‚  â”‚      - Check if answer contains:                                  â”‚  â”‚  â”‚
â”‚  â”‚        * "MÃ¬nh lÃ  trá»£ lÃ½..."                                      â”‚  â”‚  â”‚
â”‚  â”‚        * "luÃ´n sáºµn sÃ ng..."                                       â”‚  â”‚  â”‚
â”‚  â”‚        * "báº¡n cá»© Ä‘áº·t cÃ¢u há»i..."                                  â”‚  â”‚  â”‚
â”‚  â”‚      - IF small talk detected:                                    â”‚  â”‚  â”‚
â”‚  â”‚        â†’ Clear final_answer, use fallback                         â”‚  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: ANSWER SELECTION & FALLBACK                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 6.1. Decision Tree                                                â”‚  â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      â”‚ IF final_answer (from model) exists:                     â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   IF small talk detected:                                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚     IF retrieval_success:                                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ Use _build_fallback_answer() (source: fallback)  â”‚  â”‚  â”‚
â”‚  â”‚      â”‚     ELSE:                                                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ Use error message (source: fallback_no_rag)      â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   ELSE:                                                  â”‚  â”‚  â”‚
â”‚  â”‚      â”‚     IF retrieval_success:                                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ Append RAG citation to model answer              â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ source: model_with_rag_citation                  â”‚  â”‚  â”‚
â”‚  â”‚      â”‚     ELSE:                                                â”‚  â”‚  â”‚
â”‚  â”‚      â”‚       â†’ Use model answer only (source: model_no_rag)     â”‚  â”‚  â”‚
â”‚  â”‚      â”‚ ELSE:                                                    â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   IF retrieval_success:                                  â”‚  â”‚  â”‚
â”‚  â”‚      â”‚     â†’ Use _build_fallback_answer() (source: fallback)    â”‚  â”‚  â”‚
â”‚  â”‚      â”‚   ELSE:                                                  â”‚  â”‚  â”‚
â”‚  â”‚      â”‚     â†’ Return error status                                â”‚  â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: STREAMING RESPONSE                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 7.1. Stream Answer to Frontend                                     â”‚  â”‚  â”‚
â”‚  â”‚      - For each word in final_answer:                             â”‚  â”‚  â”‚
â”‚  â”‚        yield word + " "                                            â”‚  â”‚  â”‚
â”‚  â”‚      - Frontend displays text as it streams                        â”‚  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Chi tiáº¿t cÃ¡c Component

### 1. **Data Loading & Indexing**

```
nd168_metadata_clean.json
    â”‚
    â”œâ”€> Load JSON (1459 records)
    â”‚
    â”œâ”€> Parse each chunk:
    â”‚   - doc_id, article, khoan, diem
    â”‚   - tags (Set[str])
    â”‚   - content, penalty_min, penalty_max
    â”‚   - point_deduction, license_suspension_months
    â”‚
    â”œâ”€> Build behavior_index:
    â”‚   behavior_index[tag] = [chunk_idx1, chunk_idx2, ...]
    â”‚
    â”œâ”€> Build escalation_chunks:
    â”‚   Chunks that reference other articles
    â”‚
    â””â”€> Build doc_id_to_chunk_idx:
        Mapping for semantic search
```

### 2. **Semantic Index Building** (Pre-computed)

```
scripts/build_semantic_index.py
    â”‚
    â”œâ”€> Load nd168_metadata_clean.json
    â”‚
    â”œâ”€> Extract text from each chunk:
    â”‚   content / text / diem_text
    â”‚
    â”œâ”€> Encode with SentenceTransformer:
    â”‚   Model: paraphrase-multilingual-MiniLM-L12-v2
    â”‚   Output: embeddings (N x 384)
    â”‚
    â””â”€> Save to backend/semantic_index/:
        - embeddings.npy
        - metadata.json (doc_id, article, khoan, diem)
        - config.json (model_name, normalize_embeddings)
```

### 3. **Tag Detection Flow**

```
Query: "xe mÃ¡y vÆ°á»£t Ä‘Ã¨n Ä‘á» bá»‹ pháº¡t bao nhiÃªu"
    â”‚
    â”œâ”€> Lowercase: "xe mÃ¡y vÆ°á»£t Ä‘Ã¨n Ä‘á» bá»‹ pháº¡t bao nhiÃªu"
    â”‚
    â”œâ”€> Match BEHAVIOR_KEYWORDS:
    â”‚   - "vÆ°á»£t Ä‘Ã¨n Ä‘á»" â†’ den_tin_hieu âœ“
    â”‚   - "xe mÃ¡y" â†’ vehicle_type = 7 âœ“
    â”‚
    â””â”€> query_tags = {"den_tin_hieu"}
```

### 4. **Semantic Search Flow**

```
Query: "xe mÃ¡y vÆ°á»£t Ä‘Ã¨n Ä‘á»"
    â”‚
    â”œâ”€> Encode query:
    â”‚   encoder.encode(query) â†’ [0.12, -0.45, 0.78, ...] (384D)
    â”‚
    â”œâ”€> Cosine similarity:
    â”‚   scores = embeddings @ query_embedding
    â”‚   scores = [0.85, 0.72, 0.68, 0.45, ...]
    â”‚
    â”œâ”€> Top-K selection:
    â”‚   top_5 = [(idx_9, 0.85), (idx_67, 0.72), ...]
    â”‚
    â””â”€> Map to chunks:
        chunk_indices = [9, 67, 6, ...]
```

### 5. **Filtering Pipeline**

```
All chunks (1000+)
    â”‚
    â”œâ”€> Filter by subject (CÃ¡ nhÃ¢n/Tá»• chá»©c)
    â”‚   â†’ 500 chunks
    â”‚
    â”œâ”€> Filter by vehicle type (Xe mÃ¡y/Ã” tÃ´)
    â”‚   â†’ 200 chunks
    â”‚
    â”œâ”€> Filter by content keywords
    â”‚   â†’ 50 chunks
    â”‚
    â”œâ”€> Filter by speed range (if applicable)
    â”‚   â†’ 10 chunks
    â”‚
    â””â”€> Select primary chunk
        â†’ 1 chunk (primary) + escalation chunks
```

---

## ğŸ“Š Data Structures

### ChunkMetadata
```python
@dataclass
class ChunkMetadata:
    article: int              # Äiá»u 6, 7, 35, ...
    khoan: int                # Khoáº£n 1, 2, 3, ...
    diem: Optional[str]       # Äiá»ƒm a, b, c, ...
    doc_id: Optional[str]    # ND168_art6_k1_a
    tags: Set[str]            # {"den_tin_hieu", "xe_may"}
    content: str              # Full text of the law
    penalty_min: Optional[int]
    penalty_max: Optional[int]
    point_deduction: Optional[int]
    license_suspension_months: Optional[Tuple[int, int]]
    is_escalation: bool
    escalation_refs: Set[Tuple[int, int, Optional[str]]]
    priority: int
```

### Retrieval Result
```python
{
    "status": "success",
    "primary_chunk": {
        "reference": "Äiá»u 6 khoáº£n 9 Ä‘iá»ƒm b",
        "content": "9. Pháº¡t tiá»n tá»« 18.000.000 Ä‘á»“ng...",
        "penalty": {
            "min": 18000000,
            "max": 20000000,
            "text": "18,000,000Ä‘ - 20,000,000Ä‘"
        },
        "point_deduction": 4,
        "license_suspension": (4, 6),
        ...
    },
    "escalation_chunks": [...],
    "context": "=== THÃ”NG TIN LUáº¬T CHÃNH ===\n..."
}
```

---

## ğŸ¯ Key Decision Points

1. **Guardrail â†’ RAG?**
   - Small talk? â†’ Return immediately
   - Out of scope? â†’ Return immediately
   - Legal question? â†’ Continue to RAG

2. **Tag-based vs Semantic?**
   - Has tags? â†’ Use tag-based + semantic
   - No tags? â†’ Rely on semantic only (if enabled)

3. **Model vs Fallback?**
   - Model answer valid? â†’ Use model + RAG citation
   - Model answer small talk? â†’ Use fallback from RAG
   - No model answer? â†’ Use fallback from RAG

---

## ğŸ”„ Complete Flow Example

**Input:** "xe mÃ¡y vÆ°á»£t Ä‘Ã¨n Ä‘á» bá»‹ pháº¡t bao nhiÃªu"

1. **Normalize:** "xe mÃ¡y vÆ°á»£t Ä‘Ã¨n Ä‘á» bá»‹ pháº¡t bao nhiÃªu"
2. **Guardrail:** None (legal question)
3. **Rewrite:** (no change)
4. **RAG:**
   - Tags: `{"den_tin_hieu"}`
   - Vehicle: 7 (xe mÃ¡y)
   - Tag-based: chunks with `den_tin_hieu` tag
   - Semantic: top-15 similar chunks
   - Filter: article == 7, xe mÃ¡y in content
   - Select: Äiá»u 7 khoáº£n 7 Ä‘iá»ƒm c (highest penalty)
5. **Context:** "Theo Äiá»u 7 khoáº£n 7 Ä‘iá»ƒm c, 7. Pháº¡t tiá»n tá»« 4.000.000 Ä‘á»“ng..."
6. **Model:** Generate answer (if enabled)
7. **Filter:** Check for small talk
8. **Output:** Model answer + RAG citation (or fallback if model failed)

---

## ğŸ“ Notes for Visualization

- **Colors:**
  - Blue: Input/Output
  - Green: Processing steps
  - Yellow: Decision points
  - Red: Error/fallback paths
  - Purple: Data structures

- **Arrows:**
  - â†’ Normal flow
  - â‡¢ Conditional flow
  - â‡„ Bidirectional (merge results)

- **Boxes:**
  - Rectangle: Process
  - Diamond: Decision
  - Cylinder: Data storage

---

## ğŸ› ï¸ Tools Used

- **RAG:** `rag_pipeline_with_points.py`
- **Semantic:** `sentence-transformers`
- **Model:** `Qwen3-0.6B-Instruct` (via Unsloth)
- **Backend:** FastAPI
- **Frontend:** React/HTML (streaming)

---

*Generated for Legal Chatbot Demo - RAG Pipeline Documentation*

